<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
        <title>Tetris</title>

        <!-- THIS FIRST -->

        <script src="jquery-1.11.2.min.js"></script>
        <script src="pixi.js"></script>




        <!--<script src="tetris.js"></script>-->

        <!-- CSS Stuff -->

    </head>
    <body id="body">

    <div id="score"></div>

    <div id="end"></div>

    <!-- <div class="c4"> </div>-->

    </body>

        <script>

            var color_array = [0xff0000, 0x00ff00, 0x0000ff];
            var color_index = 0;

            var globalScore = 0;

            class Piece
            {
               // var color;

               // constructor(container, i , j, color)
                constructor (color, i, j, values)
                {
                    this.color = color;
                    this.values = values;

                    // Set pieces based on color???
                    /*if (color_index % 2 == 1)
                    {
                        this.values = [
                                [0, 0],
                                [0, 1],
                                [1, 0],
                                [1, 1]
                        ]
                    }
                    else
                    {
                        this.values = [
                                [0, 0],
                                [0, 1],
                                [1, 1],
                                [1, 2]
                        ]
                    }*/
                    // Set position of piece
                    this.i = i;
                    this.j = j;
                }

                down ()
                {
                    this.j++;
                }

                up()
                {
                    this.j--;
                }

                left()
                {
                    this.i--;
                    if (this.i < 0)
                            this.i = 0;
                }

                right()
                {
                    //this.i++;
                    if (this.i + 1 > 9)
                            this.i = 9;
                    else
                            this.i++;
                }

                draw(matrix)
                {
                    for (var i = 0; i < this.values.length; i++)
                    {
                        var cell = matrix[this.i + this.values[i][0]][this.j + this.values[i][1]];
                        cell.visible = true;
                        cell.color = this.color;
                        cell.draw();
                    }
                }

                fill(matrix)
                {
                    for (var i = 0; i < this.values.length; i++)
                    {
                        var cell = matrix[this.i + this.values[i][0]][this.j + this.values[i][1]];
                        cell.visible = true;
                        cell.color = this.color;
                        cell.filled = true;
                        cell.draw()
                    }
                }
                conflict(matrix)
                {
                    for (var i = 0; i < this.values.length; i++)
                    {
                        var i_offset = this.i + this.values[i][0];
                        var j_offset = this.j + this.values[i][1];
                        if (j_offset >= 20) return true;
                        var cell = matrix[i_offset][j_offset];
                        console.log(cell);
                        if (cell.filled) return true
                    }
                    return false
                }
            }

            // Create subclasses for game pieces
            class CyanI extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [0,0],
                        [1,0],
                        [2,0],
                        [3,0]
                    ];

                    var color = 0x00FFFF;

                    super(color, 3, 0, values);
                }
            }

            class YellowO extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [0,0],
                        [1,0],
                        [0,1],
                        [1,1]
                    ];

                    var color = 0xFFFF00;

                    super(color, 4, 0, values);
                }
            }

            class PurpleT extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [1,0],
                        [0,1],
                        [1,1],
                        [2,1]
                    ];

                    var color = 0x800080;

                    super(color, 3, 0, values);
                }
            }

            class GreenS extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [1,0],
                        [2,0],
                        [0,1],
                        [1,1]
                    ];

                    var color = 0x00FF00;

                    super(color, 3, 0, values);
                }
            }

            class RedZ extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [0,0],
                        [1,0],
                        [1,1],
                        [2,1]
                    ];

                    var color = 0xFF0000;

                    super(color, 3, 0, values);
                }
            }

            class BlueJ extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [0,0],
                        [0,1],
                        [1,1],
                        [2,1]
                    ];

                    var color = 0x0000FF;

                    super(color, 3, 0, values);
                }
            }

            class OrangeL extends Piece
            {
                constructor(container)
                {
                    var values = [
                        [2,0],
                        [0,1],
                        [1,1],
                        [2,1]
                    ];

                    var color = 0xFFA500;

                    super(color, 3, 0, values);
                }
            }


            class Cell
            {
                constructor(container, i, j)
                {
                    this.square = new PIXI.Graphics();
                    container.addChild(this.square);
                    this.square.x = i * 25;
                    this.square.y = j * 25;

                    this.square.mouseover = function() {
                        console.log("mouse over")
                    };

                    this.filled = false;
                    this.color = 0xffffff
                }
                draw()
                {
                    this.square.clear();
                    this.square.beginFill(this.color);
                    this.square.drawRect(0, 0, 25, 25);
                    this.square.endFill()
                }
                set visible(value)
                {
                    this.square.visible = value
                }
            }

            class Tetris
            {
                constructor(stage)
                {
                    console.log("constructor for tetris");
                    this.board = new PIXI.Sprite();
                    this.outline = new PIXI.Graphics();
                    this.board.x = 50;
                    this.board.y = 50;
                    this.draw_outline();
                    this.board.addChild(this.outline);
                    this.build_matrix(this.board);
                    stage.addChild(this.board);

                    // Randomly generate a piece
                    //this.select_random_piece();
                    var random = Math.floor((Math.random() * 3) + 1);

                    if (random == 1)
                        this.current_piece = new CyanI();
                    else if (random == 2)
                        this.current_piece = new BlueJ();
                    else
                        this.current_piece = new OrangeL();

                   /* if (random == 1)
                        this.current_piece = new CyanI();
                    else if (random == 2)
                        this.current_piece = new YellowO();
                    else if (random == 3)
                        this.current_piece = new PurpleT();
                    else if (random == 4)
                        this.current_piece = new GreenS();
                    else if (random == 5)
                        this.current_piece = new RedZ();
                    else if (random == 6)
                        this.current_piece = new BlueJ();
                    else
                        this.current_piece = new OrangeL();*/

                    this.draw_piece();
                    document.addEventListener('keydown', this.handle_key_presses.bind(this))
                    this.started = true;
                }

                clear_row(row)
                {
                    globalScore += 10;

                    document.getElementById("score").innerHTML="Your score is: " + globalScore.toString();


                    for (var j = row; j >= 0; j--)
                    {
                        for (var i = 0; i < 10; i++)
                        {
                            if (j != 0)
                            {
                                var aboveCell = this.board_matrix[i][j - 1];
                                if (aboveCell.filled)
                                {
                                    this.board_matrix[i][j].color = aboveCell.color;
                                    this.board_matrix[i][j].visible = true;
                                    this.board_matrix[i][j].filled = true;
                                }
                                else
                                {
                                    this.board_matrix[i][j].visible = false;
                                    this.board_matrix[i][j].filled = false;
                                }
                            }
                            else
                            {
                                this.board_matrix[i][j].visible = false;
                                this.board_matrix[i][j].filled = false;

                            }

                            this.board_matrix[i][j].draw();
                        }
                    }
                }

                handle_key_presses(key)
                {
                    if (key.code == "ArrowDown")
                    {
                        this.current_piece.down();
                        if (this.current_piece.conflict(this.board_matrix))
                        {
                            this.current_piece.up();
                            this.current_piece.fill(this.board_matrix);

                            // Insert full row code here??
                            for (var j = 0; j < 20; j++)
                            {
                                var filledCells = 0;

                                for (var i = 0; i < 10; i++)
                                {
                                    if (this.board_matrix[i][j].filled == true)
                                            filledCells++;
                                }

                                if (filledCells == 10)
                                        this.clear_row(j);

                            }

                            // Randomly generate a piece
                            //this.select_random_piece();
                            var random = Math.floor((Math.random() * 3) + 1);

                            if (random == 1)
                                this.current_piece = new CyanI();
                            else if (random == 2)
                                this.current_piece = new BlueJ();
                            else
                                this.current_piece = new OrangeL();

                           /* if (random == 1)
                                this.current_piece = new CyanI();
                            else if (random == 2)
                                this.current_piece = new YellowO();
                            else if (random == 3)
                                this.current_piece = new PurpleT();
                            else if (random == 4)
                                this.current_piece = new GreenS();
                            else if (random == 5)
                                this.current_piece = new RedZ();
                            else if (random == 6)
                                this.current_piece = new BlueJ();
                            else
                                this.current_piece = new OrangeL();*/

                            this.draw_piece()
                        }
                    }
                    if (key.code == "ArrowLeft")
                    {
                        this.current_piece.left();
                        if (this.current_piece.conflict(this.board_matrix))
                        {
                            this.current_piece.right()
                        }
                    }
                    if (key.code == "ArrowRight")
                    {
                        this.current_piece.right();
                        if (this.current_piece.conflict(this.board_matrix))
                        {
                            this.current_piece.left()
                        }
                    }
                    this.clear_board();
                    this.draw_piece()
                }

                draw_piece()
                {
                    this.current_piece.draw(this.board_matrix);
                }

                build_matrix(container)
                {
                    this.board_matrix = [];
                    for (var i = 0; i < 10; i++)
                    {
                        this.board_matrix[i] = [];
                        for (var j = 0; j < 20; j++)
                        {
                            this.board_matrix[i][j] = new Cell(container, i, j);
                            this.board_matrix[i][j].visible = false
                        }
                    }
                }

                clear_board()
                {
                    for (var i = 0; i < 10; i++)
                    {
                        for (var j = 0; j < 20; j++)
                        {
                            this.board_matrix[i][j].draw();
                            if (this.board_matrix[i][j].filled)
                            {
                                this.board_matrix[i][j].visible = true
                            }
                            else
                            {
                                this.board_matrix[i][j].visible = false
                            }
                        }
                    }
                }

                draw_outline()
                {
                    this.outline.clear();
                    this.outline.lineStyle(2, 0xCCCCCC);
                    this.outline.beginFill();
                    this.outline.drawRect(0, 0, 250, 500);
                    this.outline.endFill()
                }


                select_random_piece()
                {
                    var random = Math.floor((Math.random() * 7) + 1);

                    if (random == 1)
                    {
                        if (this.board_matrix[3][0].filled == true || this.board_matrix[4][0].filled == true || this.board_matrix[5][0].filled == true
                            || this.board_matrix[6][0].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new CyanI();

                        }
                    }
                     else if (random == 2)
                        if (this.board_matrix[4][0].filled == true || this.board_matrix[5][0].filled == true || this.board_matrix[4][1].filled == true
                                || this.board_matrix[5][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new YellowO();

                        }
                     else if (random == 3)
                        if (this.board_matrix[4][0].filled == true || this.board_matrix[3][1].filled == true || this.board_matrix[4][1].filled == true
                                || this.board_matrix[5][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new PurpleT();
                        }
                     else if (random == 4)
                        if (this.board_matrix[4][0].filled == true || this.board_matrix[5][0].filled == true || this.board_matrix[3][1].filled == true
                                || this.board_matrix[4][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new GreenS();
                        }
                     else if (random == 5)
                        if (this.board_matrix[3][0].filled == true || this.board_matrix[4][0].filled == true || this.board_matrix[4][1].filled == true
                                || this.board_matrix[5][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new RedZ();
                        }
                     else if (random == 6)
                        if (this.board_matrix[3][0].filled == true || this.board_matrix[3][1].filled == true || this.board_matrix[4][1].filled == true
                                || this.board_matrix[5][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new BlueJ();
                        }
                     else
                        if (this.board_matrix[5][0].filled == true || this.board_matrix[3][1].filled == true || this.board_matrix[4][1].filled == true
                                || this.board_matrix[5][1].filled == true)
                        {
                            this.end_game();
                        }
                        else
                        {
                            this.current_piece = new OrangeL();
                        }
                }




                end_game()
                {
                    document.getElementById("end").innerHTML="You suck!";
                }
            }
            var stage;
            var renderer;

            function doit()
            {
                $("body").append("hello")
            }

            function animate()
            {
                requestAnimationFrame(animate);
                renderer.render(stage)
            }

           // function after_load()
           // {
                stage = new PIXI.Container();
                stage.interactive = true;
                renderer = PIXI.autoDetectRenderer(500, 1000, null);
                document.body.appendChild(renderer.view);
                requestAnimationFrame(animate);
                var tetris = new Tetris(stage);
                window.setInterval(drop_piece_down, 1000);

           // }


            function drop_piece_down() {
                if (tetris.started) {
                    tetris.current_piece.down();
                    //tetris.check_board();
                    tetris.clear_board();
                    tetris.draw_piece();
                }
            }


           // after_load();


            document.getElementById("score").innerHTML="Your score is: " + globalScore.toString();

        </script>
</html>